<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mora Bets</title>
  <style>
    :root{--bg:#0f1420;--card:#161b28;--stroke:#2b3245;--text:#e6e9f2;--muted:#9aa4bf;--green:#2dd36f;--amber:#f9d65a;}
    html,body{background:var(--bg);color:var(--text);margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    .wrap{max-width:1200px;margin:0 auto;padding:24px 16px 56px}
    .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    h1{margin:0;font-size:22px}
    .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:14px}
    @media(min-width:900px){.grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:14px;padding:14px}
    .row{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .pill{font-size:12px;border:1px solid var(--stroke);padding:3px 8px;border-radius:999px;color:#cbd3ee}
    .over{color:var(--green);font-weight:600}
    .under{color:var(--amber)}
    .tiny-link{display:inline-flex;align-items:center;gap:6px;color:#9dd0ff;font-size:12px;cursor:pointer;text-decoration:none;border-bottom:1px dashed #2b3245}
    .tiny-link:hover{color:#cfe6ff}
    /* big loading overlay */
    .loading{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(10,14,24,.85);backdrop-filter:saturate(140%) blur(2px);z-index:10;flex-direction:column;text-align:center;padding:24px}
    .spinner{width:44px;height:44px;border:3px solid #2b3245;border-top-color:#9dd0ff;border-radius:50%;animation:spin 0.9s linear infinite;margin-bottom:12px}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div id="loading" class="loading">
    <div class="spinner"></div>
    <div style="font-weight:700">Loading 1,000+ props…</div>
    <div class="muted" style="margin-top:6px">This can take a few seconds on first load.</div>
  </div>

  <div class="wrap">
    <div class="top">
      <h1>Mora Bets</h1>
      <div class="muted"><span id="count">–</span> props</div>
    </div>

    <div id="props" class="grid"></div>
  </div>

  <!-- trend modal -->
  <div id="trendModal" style="position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:20px">
    <div style="background:#0e1422;border:1px solid #2b3245;border-radius:14px;max-width:520px;width:100%;padding:16px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div>
          <div id="trendTitle" style="font-weight:700"></div>
          <div id="trendSub" class="muted" style="font-size:12px"></div>
        </div>
        <button onclick="trendClose()" style="background:transparent;color:#9aa4bf;border:1px solid #2b3245;padding:6px 10px;border-radius:8px;cursor:pointer">Close</button>
      </div>
      <div id="trendBody" class="muted">Loading…</div>
      <div id="trendKPI" style="display:none;gap:10px;flex-wrap:wrap;margin-top:8px"></div>
    </div>
  </div>

<script>
(async function(){
  const grid = document.getElementById('props');
  const countEl = document.getElementById('count');
  const loader = document.getElementById('loading');
  const today = new Date().toISOString().slice(0,10);

  const esc = (s)=> (s??'').toString().replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m]));
  const pct = (x)=> Math.round((Number(x)||0)*100);
  function americanToProb(odds){ if(odds==null) return 0; const o=Number(odds); if(!isFinite(o)||o===0) return 0; return o>0?100/(o+100):(-o)/(100-o); }

  function flatten(data){
    if(Array.isArray(data)) return data;
    if(data && typeof data==='object'){
      const out=[]; for(const [k, arr] of Object.entries(data)){ if(Array.isArray(arr)) for(const p of arr){ out.push({...p, matchup:k}); } }
      return out;
    }
    return [];
  }

  function scoreOver(p){
    const fair = p?.fair?.prob?.over ?? 0;
    return (fair && fair>0) ? fair : americanToProb(p?.odds);
  }

  function trendLinkHTML(p){
    return `<a class="tiny-link" onclick="showTrend(${encodeURIComponent(JSON.stringify({player:p.player, stat:p.stat, line:p.line}))})">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 6 12 13 7 10 2 13"></polyline><polyline points="22 10 12 17 7 14 2 17"></polyline></svg>
      Show last 10 games trend
    </a>`;
  }

  function renderCard(p){
    const over = pct(p?.fair?.prob?.over ?? 0);
    const under = pct(p?.fair?.prob?.under ?? 0);
    const src = (p?.fair?.book || p?.shop || '').toString().toUpperCase();
    const stat = (p?.stat ?? '').toString();
    // embed a small l10 hint if present (for emergency FE fallback)
    const l10 = p?.meta?.l10 ? ` data-l10="${esc(JSON.stringify(p.meta.l10))}"` : '';
    return `
      <div class="card"${l10} data-name="${esc((p.player||'').toLowerCase())}" data-stat="${esc(stat.toLowerCase())}">
        <div class="row">
          <div class="muted">${esc(p.matchup || '')}</div>
          <div class="pill">${esc(stat)} ${esc(p.line)}</div>
        </div>
        <div style="margin-top:8px;font-weight:700">${esc(p.player || '')}</div>
        <div style="margin-top:8px">${trendLinkHTML(p)}</div>
        <div style="margin-top:10px">
          <div class="over">Over ${over}%</div>
          <div class="under">Under ${under}%</div>
        </div>
        <div class="muted" style="margin-top:8px;font-size:12px">${src ? `Source: ${esc(src)}` : ''}</div>
      </div>
    `;
  }

  async function fetchAllProps(){
    const urls = [
      `/player_props?league=mlb&date=${today}`,
      `/player_props?league=mlb`
    ];
    for(const url of urls){
      try{
        const res = await fetch(url, {cache:"no-store"});
        if(!res.ok) continue;
        const json = await res.json();
        return flatten(json);
      }catch(e){}
    }
    return [];
  }

  loader.style.display = 'flex';
  const all = await fetchAllProps();
  all.sort((a,b)=> scoreOver(b) - scoreOver(a));
  countEl.textContent = all.length.toLocaleString();
  grid.innerHTML = all.length ? all.map(renderCard).join('') : `<div class="card"><div class="muted">No props found.</div></div>`;
  loader.style.display = 'none';

  // trend modal plumbing
  window.trendClose = function(){ document.getElementById('trendModal').style.display = 'none'; };
  function mapStatForContext(s){
    const t = String(s||'').toLowerCase();
    const m = { "hits":"batter_hits", "total_bases":"batter_total_bases", "tb":"batter_total_bases" };
    return m[t] || s;
  }
  window.showTrend = async function(encoded){
    const payload = JSON.parse(decodeURIComponent(encoded));
    const {player, stat, line} = payload || {};
    const modal = document.getElementById('trendModal');
    const title = document.getElementById('trendTitle');
    const sub = document.getElementById('trendSub');
    const body = document.getElementById('trendBody');
    const kpi = document.getElementById('trendKPI');

    title.textContent = player || '';
    sub.textContent = `${stat ?? ''} ${line ?? ''}`;
    body.textContent = 'Loading…';
    kpi.style.display = 'none'; kpi.innerHTML = '';
    modal.style.display = 'flex';

    const qs = new URLSearchParams({ player_name: player||'', stat_type: mapStatForContext(stat)||'', threshold: (line??1).toString() });
    const tryUrls = [ `/contextual/hit_rate?${qs}`, `/contextual/hit-rate?${qs}`, `/contextual?${qs}` ];
    let resp = null;
    for(const u of tryUrls){ try{ const r = await fetch(u); if(r.ok){ resp = await r.json(); break; } }catch(e){} }

    if(!resp){
      // FE fallback using embedded meta.l10 if present
      const card = Array.from(document.querySelectorAll('.card')).find(el => el.querySelector('.pill')?.textContent?.includes(`${stat} ${line}`) && el.querySelector('div[style*="font-weight:700"]')?.textContent === player);
      const meta = card?.getAttribute('data-l10');
      if(meta){
        const m = JSON.parse(meta); const rate = Number(m.rate_over||0); const size = Number(m.games||10);
        body.innerHTML = `Over in <b>${Math.round(rate*size)}</b> of last <b>${size}</b> games (${Math.round(rate*100)}%)`;
        return;
      }
      body.textContent='Could not load last 10 games.'; return;
    }

    const rate = Number(resp.hit_rate ?? 0);
    const size = Number(resp.sample_size ?? 10);
    const conf = resp.confidence || '';
    body.innerHTML = `Over in <b>${Math.round(rate*size)}</b> of last <b>${size}</b> games (${Math.round(rate*100)}%)`;
    kpi.style.display = 'flex';
    kpi.innerHTML = `<div>Confidence: <b>${conf}</b></div><div>Threshold: <b>${(resp.threshold ?? line ?? 1)}</b></div>${resp.pitcher_hand ? `<div>Pitcher hand: <b>${resp.pitcher_hand}</b></div>`:''}`;
  };
})();
</script>
</body>
</html>
