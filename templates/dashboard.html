<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mora Bets — Top Props</title>
  <link rel="icon" href="/favicon.ico" type="image/x-icon" />
  <style>
    :root{--bg:#0f1420;--card:#161b28;--stroke:#2b3245;--text:#e6e9f2;--muted:#9aa4bf;--accent:#7c6dff;--green:#2dd36f;--amber:#f9d65a;--rose:#ff6b81;}
    html,body{background:var(--bg);color:var(--text);margin:0}
    .wrap{max-width:1200px;margin:0 auto;padding:24px 16px 56px}
    .title{font-size:24px;font-weight:700;margin:0 0 12px}
    .toolbar{display:flex;gap:10px;align-items:center;justify-content:center;margin:8px 0 18px}
    .tab{background:transparent;color:var(--muted);border:1px solid var(--stroke);padding:8px 12px;border-radius:999px;cursor:pointer}
    .tab.active{color:var(--text);border-color:var(--accent);box-shadow:0 0 0 1px var(--accent) inset}
    .pill{font-size:12px;border:1px solid var(--stroke);padding:4px 8px;border-radius:999px;color:var(--muted)}
    .badge{font-size:11px;border:1px solid var(--stroke);padding:3px 8px;border-radius:999px;margin-right:6px;background:#1a2134;color:#cbd3ee}
    .badge--high{background:#1f2638;border-color:#38405a;color:#ffd56a}
    .badge--fav{background:#1e2436;border-color:#3a4160;color:#a7b1ff}
    .search{width:100%;max-width:480px;padding:10px 12px;border-radius:10px;background:var(--card);border:1px solid var(--stroke);color:var(--text)}
    .grid{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:14px}
    @media(min-width:900px){.grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:14px;padding:14px}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .muted{color:var(--muted)}
    .over{color:var(--green);font-weight:600}
    .under{color:var(--amber)}
    .load{margin:22px auto 0;display:block;padding:10px 14px;border:1px solid var(--stroke);border-radius:10px;color:var(--text);background:transparent}
    .sr-only{position:absolute;left:-9999px}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .kpi{font-size:12px;color:var(--muted)}
    .link{color:var(--muted);text-decoration:none;border-bottom:1px dashed var(--stroke)}
    .link:hover{color:var(--text);border-bottom-color:var(--accent)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <h1 class="title">Top Props</h1>
      <div class="kpi">
        <span id="counter">–</span> props &nbsp;·&nbsp;
        <a class="link" href="/dashboard_legacy">Browse by matchup (legacy)</a>
      </div>
    </div>

    <div class="toolbar">
      <button class="tab active" data-league="mlb">MLB</button>
      <button class="tab" data-league="nfl">NFL</button>
      <button class="tab" data-league="nba">NBA</button>
      <button class="tab" data-league="nhl">NHL</button>
    </div>

    <div class="toolbar" style="gap:8px">
      <label for="q" class="sr-only">Search</label>
      <input id="q" class="search" placeholder="Search players or stats…" />
    </div>

    <div id="top-props" class="grid"></div>
    <button id="load-more" class="load">Load More Props</button>
  </div>

  <script>
  (function(){
    let league='mlb';
    let limit=60, offset=0;
    const grid=document.getElementById('top-props');
    const loadBtn=document.getElementById('load-more');
    const q=document.getElementById('q');
    const counter=document.getElementById('counter');
    let labelMap = {}; // matchup -> labels
    function pct(x){ return Math.round(Number(x)*100); }
    function esc(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

    async function loadLabels(){
      try{
        const res = await fetch(`/labels?league=${league}`);
        labelMap = await res.json();
      }catch(e){ labelMap = {}; }
    }

    function badgesHTML(matchup){
      const l = labelMap[matchup];
      if(!l) return '';
      const fav = (l.favored_team && l.favored_prob!=null)
        ? `<span class="badge badge--fav">Favored: ${esc(l.favored_team)} ${pct(l.favored_prob)}%</span>` : '';
      const hi  = l.high_scoring
        ? `<span class="badge badge--high">High scoring • Total ${esc(String(l.total_line||''))}</span>` : '';
      return (fav || hi) ? `<div style="margin:6px 0 4px;">${fav}${hi}</div>` : '';
    }

    function cardHTML(p){
      const over=pct(p.fair.prob.over);
      const under=pct(p.fair.prob.under);
      const src=(p.meta&&p.meta.source)?p.meta.source.toUpperCase():(p.fair.book||p.shop||'');
      const l10=p.meta&&p.meta.l10?`L10: ${p.meta.l10.over_hits}/${p.meta.l10.games} (${pct(p.meta.l10.rate_over)}%)`:'';
      return `
        <div class="card" data-name="${esc((p.player||'').toLowerCase())}" data-stat="${esc((p.stat||'').toLowerCase())}">
          <div class="row">
            <div class="muted">${esc(p.matchup||'')}</div>
            <div class="pill">${esc(p.stat)} ${esc(p.line)}</div>
          </div>
          ${badgesHTML(p.matchup)}
          <div style="margin-top:6px;font-weight:600;">${esc(p.player||'')}</div>
          <div style="margin-top:10px;">
            <div class="over">Over ${over}%</div>
            <div class="under">Under ${under}%</div>
          </div>
          ${l10?`<div class="muted" style="margin-top:8px;font-size:12px;">${l10}</div>`:''}
          <div class="muted" style="margin-top:8px;font-size:12px;">Source: ${esc(src)}</div>
        </div>
      `;
    }

    async function fetchPage(){
      loadBtn.disabled = true;
      try{
        const res = await fetch(`/player_props/top?league=${league}&limit=${limit}&offset=${offset}&over_only=1&min_prob=0.50&include_l10=1`);
        const data = await res.json();
        if(offset===0){ grid.innerHTML=''; }
        const items=(data.items||[]).filter(p=>{
          const s=(p.stat||'').toLowerCase();
          const ln=parseFloat(p.line||0);
          return !(s==='batter_total_bases' && ln>1.5);
        });
        items.forEach(p=> grid.insertAdjacentHTML('beforeend', cardHTML(p)));
        offset += items.length;
        counter.textContent = (data.total || 0).toLocaleString();
        loadBtn.style.display = (offset>=(data.total||0) || items.length===0) ? 'none' : 'block';
      }catch(e){
        console.error('Top props load failed', e);
        if(offset===0){ grid.innerHTML = '<div class="card"><div class="muted">Failed to load props.</div></div>'; loadBtn.style.display='none'; }
      }finally{ loadBtn.disabled=false; }
    }

    function applySearch(){
      const term=(q.value||'').trim().toLowerCase();
      Array.from(grid.children).forEach(el=>{
        if(!term){ el.style.display=''; return; }
        const name=el.getAttribute('data-name')||'';
        const stat=el.getAttribute('data-stat')||'';
        el.style.display=(name.includes(term)||stat.includes(term))?'':'none';
      });
    }

    async function refresh(){
      offset=0;
      await loadLabels();   // load badges first
      await fetchPage();    // then load first props page
    }

    document.querySelectorAll('.tab').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        league = btn.dataset.league;
        refresh();
      });
    });
    q.addEventListener('input', applySearch);
    loadBtn.addEventListener('click', fetchPage);

    refresh(); // initial
  })();
  </script>
</body>
</html>
