<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mora Bets</title>
  <style>
    :root{--bg:#0f1420;--card:#161b28;--stroke:#2b3245;--text:#e6e9f2;--muted:#9aa4bf;--green:#2dd36f;--amber:#f9d65a;}
    html,body{background:var(--bg);color:var(--text);margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    .wrap{max-width:1200px;margin:0 auto;padding:24px 16px 56px}
    .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    h1{margin:0;font-size:22px}
    .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:14px}
    @media(min-width:900px){.grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:14px;padding:14px}
    .row{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .pill{font-size:12px;border:1px solid var(--stroke);padding:3px 8px;border-radius:999px;color:#cbd3ee}
    .over{color:var(--green);font-weight:600}
    .under{color:var(--amber)}
    .search{width:100%;max-width:420px;padding:10px 12px;border-radius:10px;background:var(--card);border:1px solid var(--stroke);color:var(--text)}
    .toolbar{display:flex;gap:8px;align-items:center;margin:10px 0 18px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <h1>Mora Bets</h1>
      <div class="muted"><span id="count">–</span> props</div>
    </div>

    <div class="toolbar">
      <input id="q" class="search" placeholder="Search players or stats…" />
    </div>

    <div id="props" class="grid"></div>
  </div>

<script>
(async function(){
  const grid = document.getElementById('props');
  const countEl = document.getElementById('count');
  const q = document.getElementById('q');

  // --- helpers ---
  const pct = (x)=> Math.round((Number(x)||0)*100);
  const esc = (s)=> (s??'').toString().replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m]));
  const today = new Date().toISOString().slice(0,10);

  // fallback to odds → implied probability if fair.prob.over missing
  function americanToProb(odds){
    if(odds==null) return 0;
    const o = Number(odds);
    if(!isFinite(o) || o===0) return 0;
    return o>0 ? 100/(o+100) : (-o)/(100-o);
  }

  // Flatten response regardless of shape:
  // - case A: object { "<matchup>": [props...] }
  // - case B: array [props...]
  function flatten(data){
    if(Array.isArray(data)) return data;
    if(data && typeof data==='object'){
      const out = [];
      for(const [matchup, arr] of Object.entries(data)){
        if(!Array.isArray(arr)) continue;
        for(const p of arr){
          out.push({...p, matchup});
        }
      }
      return out;
    }
    return [];
  }

  function scoreOver(p){
    // Prefer fair over-prob, else compute from offered odds (if 'odds' represents Over)
    const fairOver = p?.fair?.prob?.over ?? 0;
    if(fairOver && fairOver>0) return fairOver;
    return americanToProb(p?.odds);
  }

  function renderCard(p){
    const over = pct(p?.fair?.prob?.over ?? 0);
    const under = pct(p?.fair?.prob?.under ?? 0);
    const src = (p?.fair?.book || p?.shop || '').toString().toUpperCase();
    const stat = (p?.stat ?? '').toString();
    return `
      <div class="card" data-name="${esc((p.player||'').toLowerCase())}" data-stat="${esc(stat.toLowerCase())}">
        <div class="row">
          <div class="muted">${esc(p.matchup || '')}</div>
          <div class="pill">${esc(stat)} ${esc(p.line)}</div>
        </div>
        <div style="margin-top:8px;font-weight:700">${esc(p.player || '')}</div>
        <div style="margin-top:10px">
          <div class="over">Over ${over}%</div>
          <div class="under">Under ${under}%</div>
        </div>
        <div class="muted" style="margin-top:8px;font-size:12px">${src ? `Source: ${esc(src)}` : ''}</div>
      </div>
    `;
  }

  async function fetchProps(){
    // Try with date param first (most backends expect it), fallback to without.
    const urls = [
      `/player_props?league=mlb&date=${today}`,
      `/player_props?league=mlb`
    ];
    for(const url of urls){
      try{
        const res = await fetch(url);
        if(!res.ok) continue;
        const json = await res.json();
        return flatten(json);
      }catch(e){ /* try next */ }
    }
    return [];
  }

  function applySearch(){
    const term=(q.value||'').trim().toLowerCase();
    for(const el of grid.children){
      if(!term){ el.style.display=''; continue; }
      const name=el.getAttribute('data-name')||'';
      const stat=el.getAttribute('data-stat')||'';
      el.style.display=(name.includes(term)||stat.includes(term))?'':'none';
    }
  }

  // --- load/sort/render ---
  const all = await fetchProps();

  // sort by highest OVER probability (fair if present; else implied from odds)
  all.sort((a,b)=> scoreOver(b) - scoreOver(a));

  // OPTIONAL: if you want only Hits & Total Bases, uncomment below
  // const keep = new Set(['hits','batter_hits','total_bases','batter_total_bases']);
  // const data = all.filter(p => keep.has(String(p.stat).toLowerCase()));

  const data = all; // showing ALL props as requested
  countEl.textContent = data.length.toLocaleString();

  if(!data.length){
    grid.innerHTML = `<div class="card"><div class="muted">No props found.</div></div>`;
  }else{
    grid.innerHTML = data.map(renderCard).join('');
  }

  q.addEventListener('input', applySearch);
})();
</script>
</body>
</html>
