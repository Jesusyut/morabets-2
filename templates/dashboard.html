<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mora Bets</title>
  <style>
    :root{--bg:#0f1420;--card:#161b28;--stroke:#2b3245;--text:#e6e9f2;--muted:#9aa4bf;--green:#2dd36f;--amber:#f9d65a;}
    html,body{background:var(--bg);color:var(--text);margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    .wrap{max-width:1200px;margin:0 auto;padding:24px 16px 56px}
    .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    h1{margin:0;font-size:22px}
    .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:14px}
    @media(min-width:900px){.grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:14px;padding:14px}
    .row{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .pill{font-size:12px;border:1px solid var(--stroke);padding:3px 8px;border-radius:999px;color:#cbd3ee}
    .over{color:var(--green);font-weight:600}
    .under{color:var(--amber)}
    .search{width:100%;max-width:420px;padding:10px 12px;border-radius:10px;background:var(--card);border:1px solid var(--stroke);color:var(--text)}
    .toolbar{display:flex;gap:8px;align-items:center;margin:10px 0 18px}
    .tiny-link{display:inline-flex;align-items:center;gap:6px;color:#9dd0ff;font-size:12px;cursor:pointer;text-decoration:none;border-bottom:1px dashed #2b3245}
    .tiny-link:hover{color:#cfe6ff}
    /* modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:20px}
    .modal.open{display:flex}
    .modal-card{background:#0e1422;border:1px solid var(--stroke);border-radius:14px;max-width:520px;width:100%;padding:16px}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .close{background:transparent;color:var(--muted);border:1px solid var(--stroke);padding:6px 10px;border-radius:8px;cursor:pointer}
    .kpi{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    .kpi div{background:#131a2a;border:1px solid #2b3245;border-radius:10px;padding:6px 10px;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <h1>Mora Bets</h1>
      <div class="muted"><span id="count">–</span> props</div>
    </div>

    <div class="toolbar">
      <input id="q" class="search" placeholder="Search players or stats…" />
    </div>

    <div id="props" class="grid"></div>
  </div>

  <!-- trend modal -->
  <div id="trendModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="trendTitle">
    <div class="modal-card">
      <div class="modal-header">
        <div>
          <div id="trendTitle" style="font-weight:700"></div>
          <div id="trendSub" class="muted" style="font-size:12px"></div>
        </div>
        <button class="close" onclick="trendClose()">Close</button>
      </div>
      <div id="trendBody" class="muted">Loading…</div>
      <div class="kpi" id="trendKPI" style="display:none"></div>
    </div>
  </div>

<script>
(async function(){
  const grid = document.getElementById('props');
  const countEl = document.getElementById('count');
  const q = document.getElementById('q');

  // --- helpers ---
  const pct = (x)=> Math.round((Number(x)||0)*100);
  const esc = (s)=> (s??'').toString().replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m]));
  const today = new Date().toISOString().slice(0,10);

  function americanToProb(odds){
    if(odds==null) return 0;
    const o = Number(odds);
    if(!isFinite(o) || o===0) return 0;
    return o>0 ? 100/(o+100) : (-o)/(100-o);
  }

  function flatten(data){
    if(Array.isArray(data)) return data;
    if(data && typeof data==='object'){
      const out = [];
      for(const [matchup, arr] of Object.entries(data)){
        if(!Array.isArray(arr)) continue;
        for(const p of arr){ out.push({...p, matchup}); }
      }
      return out;
    }
    return [];
  }

  function scoreOver(p){
    const fairOver = p?.fair?.prob?.over ?? 0;
    return fairOver>0 ? fairOver : americanToProb(p?.odds);
  }

  function trendLinkHTML(p){
    // Always present like in legacy: "Show last 10 games trend"
    return `<a class="tiny-link" onclick="showTrend(${encodeObj({player:p.player, stat:p.stat, line:p.line})})">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 6 12 13 7 10 2 13"></polyline><polyline points="22 10 12 17 7 14 2 17"></polyline></svg>
              Show last 10 games trend
            </a>`;
  }

  function renderCard(p){
    const over = pct(p?.fair?.prob?.over ?? 0);
    const under = pct(p?.fair?.prob?.under ?? 0);
    const src = (p?.fair?.book || p?.shop || '').toString().toUpperCase();
    const stat = (p?.stat ?? '').toString();
    return `
      <div class="card" data-name="${esc((p.player||'').toLowerCase())}" data-stat="${esc(stat.toLowerCase())}">
        <div class="row">
          <div class="muted">${esc(p.matchup || '')}</div>
          <div class="pill">${esc(stat)} ${esc(p.line)}</div>
        </div>
        <div style="margin-top:8px;font-weight:700">${esc(p.player || '')}</div>
        <div style="margin-top:8px">${trendLinkHTML(p)}</div>
        <div style="margin-top:10px">
          <div class="over">Over ${over}%</div>
          <div class="under">Under ${under}%</div>
        </div>
        <div class="muted" style="margin-top:8px;font-size:12px">${src ? `Source: ${esc(src)}` : ''}</div>
      </div>
    `;
  }

  async function fetchProps(){
    const urls = [
      `/player_props?league=mlb&date=${today}`,
      `/player_props?league=mlb`
    ];
    for(const url of urls){
      try{
        const res = await fetch(url);
        if(!res.ok) continue;
        const json = await res.json();
        return flatten(json);
      }catch(e){ /* try next */ }
    }
    return [];
  }

  // --- load/sort/render ---
  const all = await fetchProps();
  all.sort((a,b)=> scoreOver(b) - scoreOver(a));
  const data = all; // show all props
  countEl.textContent = data.length.toLocaleString();

  grid.innerHTML = data.length
    ? data.map(renderCard).join('')
    : `<div class="card"><div class="muted">No props found.</div></div>`;

  // search
  q.addEventListener('input', ()=>{
    const term=(q.value||'').trim().toLowerCase();
    for(const el of grid.children){
      if(!term){ el.style.display=''; continue; }
      const name=el.getAttribute('data-name')||'';
      const stat=el.getAttribute('data-stat')||'';
      el.style.display=(name.includes(term)||stat.includes(term))?'':'none';
    }
  });

  // ---- Trend modal plumbing (global funcs) ----
  window.trendClose = function(){
    document.getElementById('trendModal').classList.remove('open');
  };

  window.showTrend = async function(payload){
    const {player, stat, line} = payload || {};
    const modal = document.getElementById('trendModal');
    const title = document.getElementById('trendTitle');
    const sub = document.getElementById('trendSub');
    const body = document.getElementById('trendBody');
    const kpi = document.getElementById('trendKPI');

    title.textContent = player || '';
    sub.textContent = `${stat ?? ''} ${line ?? ''}`;
    body.textContent = 'Loading…';
    kpi.style.display = 'none';
    kpi.innerHTML = '';
    modal.classList.add('open');

    // Hit your contextual endpoint (tries several common shapes)
    const qs = new URLSearchParams({
      player_name: player || '',
      stat_type: stat || '',
      threshold: (line ?? 1).toString()
    });

    const tryUrls = [
      `/contextual/hit_rate?${qs.toString()}`,
      `/contextual/hit-rate?${qs.toString()}`,
      `/contextual?${qs.toString()}`,
      `/contextual?player=${encodeURIComponent(player||'')}&stat_type=${encodeURIComponent(stat||'')}&threshold=${encodeURIComponent(line??1)}`
    ];

    let resp = null;
    for(const u of tryUrls){
      try{
        const r = await fetch(u);
        if(r.ok){
          resp = await r.json();
          break;
        }
      }catch(e){/* keep trying */}
    }

    if(!resp){
      body.textContent = 'Could not load last 10 games. Try again later.';
      return;
    }

    // Expecting { hit_rate, sample_size, confidence, ... }
    // (Matches your get_contextual_hit_rate return)
    const rate = Number(resp.hit_rate ?? 0);
    const size = Number(resp.sample_size ?? 10);
    const conf = resp.confidence || '';

    body.innerHTML = `Over in <b>${Math.round(rate*size)}</b> of last <b>${size}</b> games (${Math.round(rate*100)}%)`;
    kpi.style.display = 'flex';
    kpi.innerHTML = `
      <div>Confidence: <b>${esc(conf)}</b></div>
      <div>Threshold: <b>${esc((resp.threshold ?? line ?? 1).toString())}</b></div>
      ${resp.pitcher_hand ? `<div>Pitcher hand: <b>${esc(resp.pitcher_hand)}</b></div>`:''}
    `;
  };

  // small utility to inline-encode object for onclick
  function encodeObj(o){
    return JSON.stringify(o).replace(/</g,'\\u003c');
  }
})();
</script>
</body>
</html>
